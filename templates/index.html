<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Sealed Tracker</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        .search-result-item:hover {
            background-color: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        /* Move Plotly modebar to top left */
        .js-plotly-plot .modebar {
            left: 0 !important;
            right: auto !important;
            justify-content: flex-start !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Navigation -->
        <nav class="gradient-bg shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-cards text-white text-2xl mr-3"></i>
                        <h1 class="text-white text-xl font-bold">Pokemon Sealed Tracker</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button 
                            v-for="tab in tabs" 
                            :key="tab.id"
                            @click="activeTab = tab.id"
                            :class="[
                                'px-4 py-2 rounded-lg font-medium transition-all duration-200',
                                activeTab === tab.id 
                                    ? 'bg-white text-purple-600 shadow-md' 
                                    : 'text-white hover:bg-white hover:bg-opacity-20'
                            ]"
                        >
                            <i :class="tab.icon + ' mr-2'"></i>
                            {{ tab.name }}
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Add Transaction Tab -->
            <div v-if="activeTab === 'add'" class="space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-plus-circle text-green-500 mr-2"></i>
                        Add New Transaction
                    </h2>

                    <!-- Transaction Type -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                        <select v-model="newTransaction.transaction_type" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                            <option value="OPEN">OPEN</option>
                        </select>
                    </div>

                    <!-- Product Search -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Product</label>
                        <div class="relative">
                            <input 
                                v-model="searchQuery" 
                                @input="searchProducts"
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="Type product name... (e.g., 'Charizard UPC', 'Base Set Booster')"
                            >
                            <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                            
                            <!-- Loading indicator -->
                            <div v-if="searchLoading" class="absolute right-3 top-4">
                                <i class="fas fa-spinner fa-spin text-purple-500"></i>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <transition name="fade">
                            <div v-if="searchResults.length > 0" class="mt-2 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <div 
                                    v-for="product in searchResults" 
                                    :key="product.productId"
                                    @click="selectProduct(product)"
                                    class="search-result-item p-3 cursor-pointer border-b border-gray-100 last:border-b-0 transition-all duration-200"
                                >
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-900">{{ product.name }}</div>
                                            <div class="text-sm text-gray-500">ID: {{ product.productId }}</div>
                                        </div>
                                        <div class="text-right text-xs text-gray-400">
                                            <div>Score: {{ product.score }}%</div>
                                            <div>Since: {{ formatDate(product.earliestDate) }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>

                        <!-- Selected Product Display -->
                        <transition name="fade">
                            <div v-if="selectedProduct" class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                <h3 class="font-medium text-purple-800 mb-2">Selected Product:</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="font-medium">Name:</span> {{ selectedProduct.name }}
                                    </div>
                                    <div>
                                        <span class="font-medium">ID:</span> {{ selectedProduct.productId }}
                                    </div>
                                    <div>
                                        <span class="font-medium">Available Since:</span> {{ formatDate(selectedProduct.earliestDate) }}
                                    </div>
                                    <div v-if="newTransaction.transaction_type !== 'BUY'">
                                        <span class="font-medium">Current Quantity:</span> {{ selectedProduct.currentQuantity || 0 }}
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>

                    <!-- Transaction Details -->
                    <div v-if="selectedProduct" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input 
                                v-model.number="newTransaction.quantity" 
                                type="number" 
                                min="1"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="1"
                            >
                        </div>
                        
                        <div v-if="newTransaction.transaction_type !== 'OPEN'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price per Unit ($)</label>
                            <input 
                                v-model="newTransaction.price_per_unit" 
                                type="number" 
                                step="0.01"
                                min="0.01"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="29.99"
                            >
                        </div>
                        <div v-else class="flex items-center justify-center bg-gray-50 rounded-lg">
                            <span class="text-gray-500 italic">No price required for OPEN transactions</span>
                        </div>
                    </div>

                    <div v-if="selectedProduct" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Date</label>
                            <input 
                                v-model="newTransaction.input_date" 
                                type="date"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                            <input 
                                v-model="newTransaction.notes" 
                                type="text"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="Purchase notes..."
                            >
                        </div>
                    </div>

                    <!-- Purchase Details (BUY transactions only) -->
                    <div v-if="selectedProduct && newTransaction.transaction_type === 'BUY'" class="mb-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4">
                            <i class="fas fa-shopping-cart text-green-500 mr-2"></i>
                            Purchase Details
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Method *</label>
                                <select 
                                    v-model="newTransaction.purchase_method"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                >
                                    <option value="">Select purchase method...</option>
                                    <option value="online">Online</option>
                                    <option value="in_person">In Person</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Location *</label>
                                <input 
                                    v-model="newTransaction.purchase_location" 
                                    type="text"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="e.g., Target, Pokemon Center, Local Game Store..."
                                    required
                                >
                            </div>
                        </div>
                        
                        <!-- Quick location buttons for common stores -->
                        <div class="mt-3">
                            <div class="text-sm text-gray-600 mb-2">Quick select common locations:</div>
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    v-for="store in commonStores" 
                                    :key="store"
                                    @click="newTransaction.purchase_location = store"
                                    type="button"
                                    class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors duration-200"
                                >
                                    {{ store }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div v-if="selectedProduct" class="flex justify-end">
                        <button 
                            @click="addTransaction"
                            :disabled="!canSubmitTransaction || submitLoading"
                            class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 transform hover:scale-105"
                        >
                            <i v-if="submitLoading" class="fas fa-spinner fa-spin mr-2"></i>
                            <i v-else class="fas fa-plus mr-2"></i>
                            {{ submitLoading ? 'Adding...' : 'Add Transaction' }}
                        </button>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                <transition name="fade">
                    <div v-if="message" 
                         :class="[
                             'p-4 rounded-lg',
                             message.type === 'success' ? 'bg-green-100 border border-green-200 text-green-800' : 'bg-red-100 border border-red-200 text-red-800'
                         ]">
                        <div class="flex items-center">
                            <i :class="[
                                'mr-2',
                                message.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'
                            ]"></i>
                            {{ message.text }}
                        </div>
                    </div>
                </transition>
            </div>

            <!-- Portfolio Overview Tab -->
            <div v-if="activeTab === 'portfolio'" class="space-y-6">
                <!-- Auto-refresh indicator -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                        Portfolio Overview
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600 mr-2">Auto-refresh:</span>
                            <button 
                                @click="toggleAutoRefresh"
                                :class="[
                                    'px-3 py-1 rounded-full text-xs font-medium transition-colors',
                                    autoRefresh ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
                                ]"
                            >
                                <i :class="autoRefresh ? 'fas fa-toggle-on' : 'fas fa-toggle-off'" class="mr-1"></i>
                                {{ autoRefresh ? 'ON' : 'OFF' }}
                            </button>
                        </div>
                        <button 
                            @click="refreshPortfolioData"
                            :disabled="refreshLoading"
                            class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium hover:bg-blue-200 transition-colors"
                        >
                            <i :class="refreshLoading ? 'fas fa-spinner fa-spin' : 'fas fa-sync'" class="mr-1"></i>
                            {{ refreshLoading ? 'Refreshing...' : 'Refresh' }}
                        </button>
                        <button 
                            @click="updatePricesAndPortfolio"
                            :disabled="priceUpdateLoading"
                            class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium hover:bg-green-200 transition-colors"
                        >
                            <i :class="priceUpdateLoading ? 'fas fa-spinner fa-spin' : 'fas fa-download'" class="mr-1"></i>
                            {{ priceUpdateLoading ? 'Updating Prices...' : 'Update Prices' }}
                        </button>
                    </div>
                </div>
                
                <!-- Price Update Status -->
                <transition name="fade">
                    <div v-if="priceUpdateMessage" 
                         :class="[
                             'p-3 rounded-lg mb-4',
                             priceUpdateMessage.type === 'success' ? 'bg-green-100 border border-green-200 text-green-800' : 'bg-yellow-100 border border-yellow-200 text-yellow-800'
                         ]">
                        <div class="flex items-center">
                            <i :class="[
                                'mr-2',
                                priceUpdateMessage.type === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle'
                            ]"></i>
                            {{ priceUpdateMessage.text }}
                        </div>
                    </div>
                </transition>
                
                <!-- Portfolio Metrics -->
                <!-- Portfolio Summary Cards: 4 columns on desktop -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Products</p>
                                <p class="text-3xl font-bold text-gray-900">{{ portfolioSummary.total_products || 0 }}</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-box text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Quantity</p>
                                <p class="text-3xl font-bold text-gray-900">{{ portfolioSummary.total_quantity || 0 }}</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-cubes text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Cost Basis</p>
                                <p class="text-3xl font-bold text-gray-900">${{ formatCurrency(portfolioSummary.total_cost_basis || 0) }}</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Value</p>
                                <p class="text-3xl font-bold text-green-700">${{ formatCurrency(portfolioSummary.current_market_value || 0) }}</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-coins text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Chart -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                        Portfolio Value Over Time
                    </h3>
                    <div id="portfolio-chart" style="height: 500px;"></div>
                </div>

                <!-- Current Holdings -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-wallet text-green-500 mr-2"></i>
                        Current Holdings
                    </h3>
                    
                    <div v-if="holdings.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th @click="sortBy('product_name')" class="cursor-pointer text-left py-3 px-2 font-medium text-gray-600">
                                            Product Name
                                            <!-- Baseline faint sort icon (inactive) -->
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'product_name'"></i>
                                            <!-- Active colored sort icon -->
                                            <i v-if="sortKey === 'product_name'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                        <th @click="sortBy('current_quantity')" class="cursor-pointer text-right py-3 px-2 font-medium text-gray-600">Quantity
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'current_quantity'"></i>
                                            <i v-if="sortKey === 'current_quantity'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                        <th @click="sortBy('average_cost_per_unit')" class="cursor-pointer text-right py-3 px-2 font-medium text-gray-600">Avg Cost/Unit
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'average_cost_per_unit'"></i>
                                            <i v-if="sortKey === 'average_cost_per_unit'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                        <th @click="sortBy('current_price_per_unit')" class="cursor-pointer text-right py-3 px-2 font-medium text-gray-600">Current Price
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'current_price_per_unit'"></i>
                                            <i v-if="sortKey === 'current_price_per_unit'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                        <th @click="sortBy('total_current_value')" class="cursor-pointer text-right py-3 px-2 font-medium text-gray-600">Current Value
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'total_current_value'"></i>
                                            <i v-if="sortKey === 'total_current_value'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                        <th @click="sortBy('pnl')" class="cursor-pointer text-right py-3 px-2 font-medium text-gray-600">P&L
                                            <i class="fa-fw fas fa-sort text-gray-300 ml-2" aria-hidden="true" v-if="sortKey !== 'pnl'"></i>
                                            <i v-if="sortKey === 'pnl'" :class="['fa-fw', sortAsc ? 'fas fa-sort-up text-purple-600' : 'fas fa-sort-down text-red-600', 'ml-2', 'transition-colors']" aria-hidden="true"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="holding in sortedHoldings" :key="holding.product_name" class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="py-3 px-2 font-medium text-gray-900">{{ holding.product_name }}</td>
                                        <td class="py-3 px-2 text-right">{{ holding.current_quantity }}</td>
                                        <td class="py-3 px-2 text-right">${{ formatCurrency(holding.average_cost_per_unit) }}</td>
                                        <td class="py-3 px-2 text-right">${{ formatCurrency(holding.current_price_per_unit) }}</td>
                                        <td class="py-3 px-2 text-right">${{ formatCurrency(holding.total_current_value) }}</td>
                                        <td class="py-3 px-2 text-right" 
                                            :class="[
                                                holding.total_current_value - holding.total_cost_basis >= 0 
                                                    ? 'text-green-600' 
                                                    : 'text-red-600'
                                            ]">
                                            {{ holding.total_current_value - holding.total_cost_basis >= 0 ? '+' : '' }}${{ formatCurrency(holding.total_current_value - holding.total_cost_basis) }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    <div v-else class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>No holdings yet. Add some transactions to see your portfolio.</p>
                    </div>
                </div>
            </div>

            <!-- Transaction History Tab -->
            <div v-if="activeTab === 'history'" class="space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-history text-blue-500 mr-2"></i>
                            Transaction History
                        </h2>
                        <select v-model="transactionFilter" @change="loadTransactions" 
                                class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="All">All Types</option>
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                            <option value="OPEN">OPEN</option>
                        </select>
                    </div>

                    <div v-if="transactions.length > 0" class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-2 font-medium text-gray-600">ID</th>
                                    <th class="text-left py-3 px-2 font-medium text-gray-600">Date</th>
                                    <th class="text-left py-3 px-2 font-medium text-gray-600">Product</th>
                                    <th class="text-center py-3 px-2 font-medium text-gray-600">Type</th>
                                    <th class="text-right py-3 px-2 font-medium text-gray-600">Quantity</th>
                                    <th class="text-right py-3 px-2 font-medium text-gray-600">Price/Unit</th>
                                    <th class="text-right py-3 px-2 font-medium text-gray-600">Total</th>
                                    <th class="text-center py-3 px-2 font-medium text-gray-600">Method</th>
                                    <th class="text-center py-3 px-2 font-medium text-gray-600">Location</th>
                                    <th class="text-center py-3 px-2 font-medium text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="transaction in transactions" :key="transaction.transaction_id" 
                                    class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-2">{{ transaction.transaction_id }}</td>
                                    <td class="py-3 px-2">{{ formatDate(transaction.transaction_date) }}</td>
                                    <td class="py-3 px-2 font-medium">{{ transaction.product_name }}</td>
                                    <td class="py-3 px-2 text-center">
                                        <span :class="[
                                            'px-2 py-1 rounded-full text-xs font-medium',
                                            transaction.transaction_type === 'BUY' ? 'bg-green-100 text-green-800' :
                                            transaction.transaction_type === 'SELL' ? 'bg-red-100 text-red-800' :
                                            'bg-blue-100 text-blue-800'
                                        ]">
                                            {{ transaction.transaction_type }}
                                        </span>
                                    </td>
                                    <td class="py-3 px-2 text-right">{{ transaction.quantity }}</td>
                                    <td class="py-3 px-2 text-right">
                                        {{ transaction.price_per_unit ? '$' + formatCurrency(transaction.price_per_unit) : 'N/A' }}
                                    </td>
                                    <td class="py-3 px-2 text-right">
                                        {{ transaction.total_amount ? '$' + formatCurrency(transaction.total_amount) : 'N/A' }}
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <span v-if="transaction.purchase_method" :class="[
                                            'px-2 py-1 rounded-full text-xs font-medium',
                                            transaction.purchase_method === 'online' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'
                                        ]">
                                            {{ transaction.purchase_method === 'online' ? 'Online' : 'In Person' }}
                                        </span>
                                        <span v-else class="text-gray-400 text-xs">-</span>
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <span v-if="transaction.purchase_location" class="text-xs">{{ transaction.purchase_location }}</span>
                                        <span v-else class="text-gray-400 text-xs">-</span>
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <button @click="deleteTransaction(transaction.transaction_id)"
                                                class="text-red-500 hover:text-red-700 transition-colors duration-200">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-4xl mb-4"></i>
                        <p>No transactions found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'add',
                    tabs: [
                        { id: 'add', name: 'Add Transaction', icon: 'fas fa-plus' },
                        { id: 'portfolio', name: 'Portfolio', icon: 'fas fa-chart-pie' },
                        { id: 'history', name: 'History', icon: 'fas fa-history' }
                    ],
                    searchQuery: '',
                    searchResults: [],
                    searchLoading: false,
                    selectedProduct: null,
                    newTransaction: {
                        product_id: '',
                        transaction_type: 'BUY',
                        quantity: 1,
                        input_date: new Date().toISOString().split('T')[0],
                        price_per_unit: null,
                        notes: '',
                        purchase_method: '',
                        purchase_location: ''
                    },
                    commonStores: [
                        'Target', 'Pokemon Center', 'Best Buy', 'Walmart', 'Costco', 
                        'GameStop', 'TikTok Shop', 'Amazon', 'eBay', 'TCGPlayer',
                        'Local Game Store', 'Vending Machine', 'Scheels'
                    ],
                    submitLoading: false,
                    message: null,
                    portfolioSummary: {},
                    holdings: [],
                    // sorting state for holdings table
                    sortKey: 'product_name',
                    sortAsc: true,
                    transactions: [],
                    transactionFilter: 'All',
                    // Auto-refresh functionality
                    autoRefresh: false,
                    refreshInterval: null,
                    refreshLoading: false,
                    lastUpdateTime: null,
                    priceUpdateLoading: false,
                    priceUpdateMessage: null
                }
            },
            computed: {
                sortedHoldings() {
                    if (!this.holdings || this.holdings.length === 0) return [];

                    // create a shallow copy to avoid mutating original array
                    const arr = this.holdings.map(h => ({ ...h }));

                    // compute P&L property for sorting
                    arr.forEach(h => { h.pnl = (parseFloat(h.total_current_value) || 0) - (parseFloat(h.total_cost_basis) || 0); });

                    const key = this.sortKey;

                    arr.sort((a, b) => {
                        let va = a[key];
                        let vb = b[key];

                        // normalize undefined/null
                        if (va === undefined || va === null) va = '';
                        if (vb === undefined || vb === null) vb = '';

                        // try numeric compare first
                        const na = parseFloat(va);
                        const nb = parseFloat(vb);
                        if (!isNaN(na) && !isNaN(nb)) {
                            return this.sortAsc ? na - nb : nb - na;
                        }

                        // fallback to string compare
                        const sa = String(va).toLowerCase();
                        const sb = String(vb).toLowerCase();
                        if (sa < sb) return this.sortAsc ? -1 : 1;
                        if (sa > sb) return this.sortAsc ? 1 : -1;
                        return 0;
                    });

                    return arr;
                },
                canSubmitTransaction() {
                    const baseValid = this.selectedProduct && this.newTransaction.quantity > 0;
                    
                    if (!baseValid) return false;
                    
                    // For OPEN transactions, no price or purchase info needed
                    if (this.newTransaction.transaction_type === 'OPEN') {
                        return true;
                    }
                    
                    // For BUY/SELL transactions, price is required
                    const priceValid = this.newTransaction.price_per_unit > 0;
                    
                    // For BUY transactions, purchase method and location are required
                    if (this.newTransaction.transaction_type === 'BUY') {
                        const purchaseValid = this.newTransaction.purchase_method && 
                                            this.newTransaction.purchase_location && 
                                            this.newTransaction.purchase_location.trim() !== '';
                        return priceValid && purchaseValid;
                    }
                    
                    // For SELL transactions, only price is required
                    return priceValid;
                }
            },
            mounted() {
                this.loadPortfolioData();
                this.loadTransactions();
                this.lastUpdateTime = new Date();
            },
            beforeUnmount() {
                this.stopAutoRefresh();
            },
            watch: {
                activeTab(newTab) {
                    if (newTab === 'portfolio') {
                        this.loadPortfolioData();
                        this.$nextTick(() => {
                            this.renderPortfolioChart();
                        });
                        if (this.autoRefresh) {
                            this.startAutoRefresh();
                        }
                    } else if (newTab === 'history') {
                        this.loadTransactions();
                        this.stopAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                }
            },
            methods: {
                sortBy(key) {
                    if (this.sortKey === key) {
                        this.sortAsc = !this.sortAsc;
                    } else {
                        this.sortKey = key;
                        this.sortAsc = true;
                    }
                },
                async searchProducts() {
                    if (!this.searchQuery || this.searchQuery.length < 2) {
                        this.searchResults = [];
                        return;
                    }

                    this.searchLoading = true;
                    try {
                        const response = await axios.get(`/api/products/search?q=${encodeURIComponent(this.searchQuery)}&limit=10`);
                        this.searchResults = response.data.products;
                    } catch (error) {
                        console.error('Search error:', error);
                        this.showMessage('Error searching products', 'error');
                    } finally {
                        this.searchLoading = false;
                    }
                },
                async selectProduct(product) {
                    this.selectedProduct = product;
                    this.newTransaction.product_id = product.productId;
                    this.searchResults = [];
                    
                    // Get detailed product info
                    try {
                        const response = await axios.get(`/api/products/${product.productId}`);
                        this.selectedProduct = { ...this.selectedProduct, ...response.data };
                    } catch (error) {
                        console.error('Error getting product details:', error);
                    }
                },
                toggleAutoRefresh() {
                    this.autoRefresh = !this.autoRefresh;
                    if (this.autoRefresh && this.activeTab === 'portfolio') {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                },
                startAutoRefresh() {
                    this.stopAutoRefresh();
                    this.refreshInterval = setInterval(() => {
                        if (this.activeTab === 'portfolio') {
                            this.refreshPortfolioData();
                        }
                    }, 30000); // Refresh every 30 seconds
                },
                stopAutoRefresh() {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                },
                async refreshPortfolioData() {
                    this.refreshLoading = true;
                    try {
                        await this.loadPortfolioData();
                        this.$nextTick(() => {
                            this.renderPortfolioChart();
                        });
                        this.lastUpdateTime = new Date();
                    } catch (error) {
                        console.error('Error refreshing portfolio data:', error);
                    } finally {
                        this.refreshLoading = false;
                    }
                },
                async updatePricesAndPortfolio() {
                    this.priceUpdateLoading = true;
                    this.priceUpdateMessage = null;
                    
                    try {
                        // Call the new API endpoint to update prices and portfolio
                        const response = await axios.post('/api/portfolio/update-prices');
                        
                        this.showPriceUpdateMessage(response.data.message, 'success');
                        
                        // Refresh portfolio data after price update
                        await this.refreshPortfolioData();
                        
                    } catch (error) {
                        const errorMsg = error.response?.data?.detail || 'Error updating prices';
                        this.showPriceUpdateMessage(errorMsg, 'error');
                        console.error('Error updating prices:', error);
                    } finally {
                        this.priceUpdateLoading = false;
                    }
                },
                async addTransaction() {
                    this.submitLoading = true;
                    try {
                        const response = await axios.post('/api/transactions', this.newTransaction);
                        
                        let message = 'Transaction added successfully!';
                        if (response.data.was_adjusted) {
                            message += ` Date was adjusted to ${response.data.adjusted_date}.`;
                        }
                        
                        this.showMessage(message, 'success');
                        this.resetForm();
                        
                        // Refresh all data automatically
                        await this.refreshAllData();
                        
                    } catch (error) {
                        const errorMsg = error.response?.data?.detail || 'Error adding transaction';
                        this.showMessage(errorMsg, 'error');
                    } finally {
                        this.submitLoading = false;
                    }
                },
                async loadPortfolioData() {
                    try {
                        const [summaryResponse, holdingsResponse] = await Promise.all([
                            axios.get('/api/portfolio/summary'),
                            axios.get('/api/portfolio/holdings')
                        ]);
                        
                        this.portfolioSummary = summaryResponse.data;
                        this.holdings = holdingsResponse.data.holdings;
                    } catch (error) {
                        console.error('Error loading portfolio data:', error);
                    }
                },
                async renderPortfolioChart() {
                    try {
                        const response = await axios.get('/api/portfolio/chart-data');
                        const data = response.data;
                        
                        if (data.dates.length === 0) {
                            document.getElementById('portfolio-chart').innerHTML = 
                                '<div class="flex items-center justify-center h-full text-gray-500"><p>No data available for chart</p></div>';
                            return;
                        }
                        
                        const trace1 = {
                            x: data.dates,
                            y: data.market_values,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Collection Value',
                            line: { color: '#3B82F6', width: 3 }
                        };
                        
                        const trace2 = {
                            x: data.dates,
                            y: data.cost_basis,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Cost Basis',
                            line: { color: '#EF4444', width: 2, dash: 'dash' }
                        };
                        
                        const layout = {
                            title: false,
                            xaxis: { title: 'Date' },
                            yaxis: { title: 'Value ($)', tickformat: '$,.0f' },
                            hovermode: 'x unified',
                            showlegend: true,
                            legend: { x: 0, y: 1 },
                            margin: { l: 80, r: 40, t: 40, b: 80 }
                        };
                        
                        Plotly.newPlot('portfolio-chart', [trace1, trace2], layout, { responsive: true });
                    } catch (error) {
                        console.error('Error rendering chart:', error);
                    }
                },
                async loadTransactions() {
                    try {
                        const params = this.transactionFilter !== 'All' ? `?transaction_type=${this.transactionFilter}` : '';
                        const response = await axios.get(`/api/transactions${params}`);
                        this.transactions = response.data.transactions;
                    } catch (error) {
                        console.error('Error loading transactions:', error);
                    }
                },
                async deleteTransaction(transactionId) {
                    if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        await axios.delete(`/api/transactions/${transactionId}`);
                        this.showMessage('Transaction deleted successfully', 'success');
                        
                        // Refresh all data automatically
                        await this.refreshAllData();
                    } catch (error) {
                        const errorMsg = error.response?.data?.detail || 'Error deleting transaction';
                        this.showMessage(errorMsg, 'error');
                    }
                },
                resetForm() {
                    this.searchQuery = '';
                    this.searchResults = [];
                    this.selectedProduct = null;
                    this.newTransaction = {
                        product_id: '',
                        transaction_type: 'BUY',
                        quantity: 1,
                        input_date: new Date().toISOString().split('T')[0],
                        price_per_unit: null,
                        notes: '',
                        purchase_method: '',
                        purchase_location: ''
                    };
                },
                showMessage(text, type) {
                    this.message = { text, type };
                    setTimeout(() => {
                        this.message = null;
                    }, 5000);
                },
                showPriceUpdateMessage(text, type) {
                    this.priceUpdateMessage = { text, type };
                    setTimeout(() => {
                        this.priceUpdateMessage = null;
                    }, 8000);
                },
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },
                formatCurrency(amount) {
                    return parseFloat(amount).toFixed(2);
                },
                async refreshAllData() {
                    // Refresh portfolio data if on portfolio tab
                    if (this.activeTab === 'portfolio') {
                        await this.loadPortfolioData();
                        this.$nextTick(() => {
                            this.renderPortfolioChart();
                        });
                    }
                    
                    // Refresh transaction history if on history tab
                    if (this.activeTab === 'history') {
                        await this.loadTransactions();
                    }
                    
                    this.lastUpdateTime = new Date();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>